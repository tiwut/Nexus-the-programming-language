<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nexus Studio</title>
    <script src="https://unpkg.com/blockly@10.0.0/blockly.min.js"></script>

    <style>
        :root { --bg: #1e1e1e; --panel: #252526; --border: #3e3e42; --accent: #007acc; --text: #000000; --green: #4caf50; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: #333; height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid var(--border); }
        .brand { font-weight: bold; color: rgb(43, 43, 43); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent); }
        
        .btn { border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; color: white; font-weight: bold; margin-left: 10px; transition: 0.2s; }
        .run { background: var(--green); } .run:hover { background: #43a047; }
        .save { background: var(--accent); } .save:hover { background: #006bb3; }

        .workspace { display: flex; flex: 1; height: calc(100vh - 50px); }
        .editor { flex: 3; height: 100%; }
        .sidebar { flex: 1; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; min-width: 300px; }
        
        .panel-header { padding: 10px; background: #2d2d30; font-size: 0.75rem; text-transform: uppercase; color: #888; border-bottom: 1px solid var(--border); font-weight: bold; }
        .code-view { flex: 1; margin: 0; padding: 15px; overflow: auto; color: #9cdcfe; font-family: monospace; background: #1e1e1e; border-bottom: 1px solid var(--border); white-space: pre-wrap; }
        .console-view { height: 200px; padding: 10px; background: #000; color: #0f0; font-family: monospace; overflow-y: auto; }
    </style>
</head>
<body>

    <header>
        <div class="brand"><span style="font-size:1.5em">ðŸ’ </span> Nexus<span>Studio</span></div>
        <div>
            <button id="runBtn" class="btn run">â–¶ Run Simulation</button>
            <button id="saveBtn" class="btn save">â¬‡ Save .nx</button>
        </div>
    </header>

    <div class="workspace">
        <div id="blocklyDiv" class="editor"></div>
        <div class="sidebar">
            <div class="panel-header">Generated Code</div>
            <pre id="codeOutput" class="code-view"></pre>
            <div class="panel-header">Console</div>
            <div id="consoleOutput" class="console-view"><span style="color:#666">Ready...</span></div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Core" colour="#FFAB00">
            <block type="nexus_out">
                <value name="TEXT"><shadow type="text"><field name="TEXT">Hello World</field></shadow></value>
            </block>
            <block type="nexus_input">
                <value name="PROMPT"><shadow type="text"><field name="TEXT">Enter Name:</field></shadow></value>
            </block>
            <block type="nexus_wait">
                <value name="SECONDS"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="nexus_comment"></block>
        </category>
        <category name="Variables" colour="#EF5350" custom="VARIABLE"></category>
        <category name="Logic" colour="#42A5F5">
            <block type="nexus_if"></block>
            <block type="nexus_loop"></block>
            <block type="logic_compare"></block>
            <block type="nexus_math_calc"></block>
            <block type="math_number"></block>
            <block type="text"></block>
        </category>
        <category name="Functions" colour="#AB47BC" custom="PROCEDURE"></category>
        <category name="GUI" colour="#66BB6A">
            <block type="nexus_gui_window"><value name="TITLE"><shadow type="text"><field name="TEXT">My App</field></shadow></value></block>
            <block type="nexus_gui_label"><value name="TEXT"><shadow type="text"><field name="TEXT">Label</field></shadow></value></block>
            <block type="nexus_gui_msg"><value name="TEXT"><shadow type="text"><field name="TEXT">Alert</field></shadow></value></block>
            <block type="nexus_gui_button">
                <value name="LABEL"><shadow type="text"><field name="TEXT">Click</field></shadow></value>
                <value name="FUNC"><shadow type="text"><field name="TEXT">funcName</field></shadow></value>
            </block>
            <block type="nexus_gui_run"></block>
        </category>
        <category name="File I/O" colour="#FFA726">
            <block type="nexus_io_write">
                <value name="FILENAME"><shadow type="text"><field name="TEXT">log.txt</field></shadow></value>
                <value name="CONTENT"><shadow type="text"><field name="TEXT">Data</field></shadow></value>
            </block>
            <block type="nexus_io_read">
                <value name="FILENAME"><shadow type="text"><field name="TEXT">log.txt</field></shadow></value>
            </block>
        </category>
        <category name="Advanced" colour="#78909C">
            <block type="nexus_generic_module"></block>
        </category>
    </xml>

    <script>
        const nexusGen = new Blockly.Generator('Nexus');
        const ORDER_ATOMIC = 0;
        const ORDER_NONE = 99;
        
        nexusGen.scrub_ = function(block, code, opt_thisOnly) {
            const nextBlock = block.nextConnection && block.nextConnection.targetBlock();
            const nextCode = opt_thisOnly ? '' : nexusGen.blockToCode(nextBlock);
            return code + nextCode;
        };

        Blockly.defineBlocksWithJsonArray([
            { "type": "nexus_out", "message0": "out %1", "args0": [{ "type": "input_value", "name": "TEXT" }], "previousStatement": null, "nextStatement": null, "colour": 40 },
            { "type": "nexus_input", "message0": "input to %1 prompt %2", "args0": [{ "type": "field_variable", "name": "VAR", "variable": "x" }, { "type": "input_value", "name": "PROMPT" }], "previousStatement": null, "nextStatement": null, "colour": 40 },
            { "type": "nexus_wait", "message0": "wait %1s", "args0": [{ "type": "input_value", "name": "SECONDS" }], "previousStatement": null, "nextStatement": null, "colour": 40 },
            { "type": "nexus_math_calc", "message0": "%1 %2 %3", "args0": [{ "type": "input_value", "name": "A" }, { "type": "field_dropdown", "name": "OP", "options": [["+", "+"], ["-", "-"], ["*", "*"], ["/", "/"]] }, { "type": "input_value", "name": "B" }], "output": null, "colour": 230 },
            { "type": "nexus_if", "message0": "if %1", "args0": [{ "type": "input_value", "name": "COND" }], "message1": "do %1", "args1": [{ "type": "input_statement", "name": "DO" }], "previousStatement": null, "nextStatement": null, "colour": 210 },
            { "type": "nexus_loop", "message0": "loop %1", "args0": [{ "type": "input_statement", "name": "DO" }], "previousStatement": null, "nextStatement": null, "colour": 120 },
            { "type": "nexus_gui_msg", "message0": "gui.msg( %1 )", "args0": [{ "type": "input_value", "name": "TEXT" }], "previousStatement": null, "nextStatement": null, "colour": 120 },
            { "type": "nexus_gui_window", "message0": "gui.window( %1 )", "args0": [{ "type": "input_value", "name": "TITLE" }], "previousStatement": null, "nextStatement": null, "colour": 120 },
            { "type": "nexus_gui_label", "message0": "gui.label( %1 )", "args0": [{ "type": "input_value", "name": "TEXT" }], "previousStatement": null, "nextStatement": null, "colour": 120 },
            { "type": "nexus_gui_button", "message0": "gui.button( %1, runs %2 )", "args0": [{ "type": "input_value", "name": "LABEL" }, { "type": "input_value", "name": "FUNC" }], "previousStatement": null, "nextStatement": null, "colour": 120 },
            { "type": "nexus_gui_run", "message0": "gui.run()", "previousStatement": null, "colour": 120 },
            { "type": "nexus_io_write", "message0": "io.write( %1, %2 )", "args0": [{ "type": "input_value", "name": "FILENAME" }, { "type": "input_value", "name": "CONTENT" }], "previousStatement": null, "nextStatement": null, "colour": 30 },
            { "type": "nexus_io_read", "message0": "io.read( %1 )", "args0": [{ "type": "input_value", "name": "FILENAME" }], "output": null, "colour": 30 },
            { "type": "nexus_generic_module", "message0": "%1 . %2 ( %3 )", "args0": [{ "type": "field_dropdown", "name": "MOD", "options": [["sys", "sys"], ["net", "net"], ["math", "math"]] }, { "type": "field_input", "name": "FUNC", "text": "cmd" }, { "type": "input_value", "name": "ARGS" }], "previousStatement": null, "nextStatement": null, "colour": 260 },
            { "type": "nexus_comment", "message0": "# %1", "args0": [{ "type": "field_input", "name": "TEXT", "text": "..." }], "previousStatement": null, "nextStatement": null, "colour": 200 }
        ]);

        
        nexusGen.forBlock['text'] = function(b) { return ['"' + b.getFieldValue('TEXT') + '"', ORDER_ATOMIC]; };
        nexusGen.forBlock['math_number'] = function(b) { return [b.getFieldValue('NUM'), ORDER_ATOMIC]; };
        
        nexusGen.forBlock['nexus_out'] = function(b) { 
            const val = nexusGen.valueToCode(b, 'TEXT', ORDER_NONE) || '""';
            return 'out ' + val + '\n'; 
        };
        
        nexusGen.forBlock['nexus_input'] = function(b) {
            const p = nexusGen.valueToCode(b, 'PROMPT', ORDER_NONE) || '""';
            const v = Blockly.Common.names.getName(b.getFieldValue('VAR'), 'VARIABLE');
            return 'input ' + v + ' ' + p + '\n';
        };

        nexusGen.forBlock['nexus_wait'] = function(b) {
            const s = nexusGen.valueToCode(b, 'SECONDS', ORDER_NONE) || '1';
            return 'wait ' + s + '\n';
        };

        nexusGen.forBlock['variables_set'] = function(b) {
            const arg = nexusGen.valueToCode(b, 'VALUE', ORDER_NONE) || '0';
            const v = Blockly.Common.names.getName(b.getFieldValue('VAR'), 'VARIABLE');
            return 'set ' + v + ' = ' + arg + '\n';
        };

        nexusGen.forBlock['variables_get'] = function(b) {
            const v = Blockly.Common.names.getName(b.getFieldValue('VAR'), 'VARIABLE');
            return [v, ORDER_ATOMIC];
        };

        nexusGen.forBlock['nexus_math_calc'] = function(b) {
            const a = nexusGen.valueToCode(b, 'A', ORDER_ATOMIC) || '0';
            const B = nexusGen.valueToCode(b, 'B', ORDER_ATOMIC) || '0';
            return [a + ' ' + b.getFieldValue('OP') + ' ' + B, ORDER_ATOMIC];
        };

        nexusGen.forBlock['nexus_if'] = function(b) {
            const c = nexusGen.valueToCode(b, 'COND', ORDER_NONE) || '1';
            const d = nexusGen.statementToCode(b, 'DO');
            return 'if ' + c + '\n' + d + 'end\n';
        };

        nexusGen.forBlock['nexus_loop'] = function(b) {
            return 'loop\n' + nexusGen.statementToCode(b, 'DO') + 'end\n';
        };

        nexusGen.forBlock['logic_compare'] = function(b) {
            const A = nexusGen.valueToCode(b, 'A', ORDER_ATOMIC) || '0';
            const B = nexusGen.valueToCode(b, 'B', ORDER_ATOMIC) || '0';
            const op = { 'EQ': '==', 'NEQ': '!=', 'LT': '<', 'LTE': '<=', 'GT': '>', 'GTE': '>=' }[b.getFieldValue('OP')];
            return [A + ' ' + op + ' ' + B, ORDER_ATOMIC];
        };

        nexusGen.forBlock['procedures_defnoreturn'] = function(b) {
            const n = nexusGen.nameDB_.getName(b.getFieldValue('NAME'), 'PROCEDURE');
            return 'fn ' + n + '\n' + nexusGen.statementToCode(b, 'STACK') + 'end\n';
        };
        nexusGen.forBlock['procedures_callnoreturn'] = function(b) {
            return nexusGen.nameDB_.getName(b.getFieldValue('NAME'), 'PROCEDURE') + '()\n';
        };

        nexusGen.forBlock['nexus_gui_msg'] = function(b) { return 'gui.msg(' + (nexusGen.valueToCode(b, 'TEXT', ORDER_NONE)||'""') + ')\n'; };
        nexusGen.forBlock['nexus_gui_window'] = function(b) { return 'gui.window(' + (nexusGen.valueToCode(b, 'TITLE', ORDER_NONE)||'""') + ')\n'; };
        nexusGen.forBlock['nexus_gui_label'] = function(b) { return 'gui.label(' + (nexusGen.valueToCode(b, 'TEXT', ORDER_NONE)||'""') + ')\n'; };
        nexusGen.forBlock['nexus_gui_button'] = function(b) { 
            return 'gui.button(' + (nexusGen.valueToCode(b, 'LABEL', ORDER_NONE)||'""') + ', ' + (nexusGen.valueToCode(b, 'FUNC', ORDER_NONE)||'""') + ')\n'; 
        };
        nexusGen.forBlock['nexus_gui_run'] = function(b) { return 'gui.run()\n'; };
        nexusGen.forBlock['nexus_io_write'] = function(b) { 
            return 'io.write(' + (nexusGen.valueToCode(b, 'FILENAME', ORDER_NONE)||'""') + ', ' + (nexusGen.valueToCode(b, 'CONTENT', ORDER_NONE)||'""') + ')\n'; 
        };
        nexusGen.forBlock['nexus_io_read'] = function(b) { return ['io.read(' + (nexusGen.valueToCode(b, 'FILENAME', ORDER_NONE)||'""') + ')', ORDER_ATOMIC]; };
        nexusGen.forBlock['nexus_generic_module'] = function(b) { 
            return b.getFieldValue('MOD') + '.' + b.getFieldValue('FUNC') + '(' + (nexusGen.valueToCode(b, 'ARGS', ORDER_NONE)||'') + ')\n'; 
        };
        nexusGen.forBlock['nexus_comment'] = function(b) { return '# ' + b.getFieldValue('TEXT') + '\n'; };

        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true, trashcan: true,
            grid: { spacing: 25, length: 3, colour: '#444', snap: true },
            zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3 },
            theme: Blockly.Themes.Dark
        });

        function updateCode() {
            try {
                const code = nexusGen.workspaceToCode(workspace);
                document.getElementById('codeOutput').textContent = code;
                document.getElementById('consoleOutput').innerHTML = "<span style='color:#666'>Ready...</span>";
            } catch (e) {
                document.getElementById('consoleOutput').innerHTML = "<span style='color:red'>Error: " + e.message + "</span>";
                console.error(e);
            }
        }
        workspace.addChangeListener(updateCode);

        document.getElementById('saveBtn').addEventListener('click', () => {
            const code = nexusGen.workspaceToCode(workspace);
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([code], { type: "text/plain" }));
            a.download = "program.nx"; a.click();
        });

        document.getElementById('runBtn').addEventListener('click', () => {
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.innerHTML = "";
            const log = (m) => { consoleDiv.innerHTML += `<div><span style="color:#0f0">â€º</span> ${m}</div>`; consoleDiv.scrollTop = consoleDiv.scrollHeight; };
            
            try {
                const lines = nexusGen.workspaceToCode(workspace).split('\n');
                log("Simulating...");
                lines.forEach(line => {
                    line = line.trim();
                    if (!line || line.startsWith('#')) return;
                    if (line.startsWith('out ')) log(line.substring(4).replace(/"/g, ''));
                    else if (line.startsWith('gui.msg')) log("[POPUP] " + line);
                    else if (line.startsWith('gui.')) log("[GUI] " + line);
                    else if (line.startsWith('io.')) log("[DISK] " + line);
                    else if (line.startsWith('input')) log("[INPUT REQUEST] " + line);
                });
            } catch(e) { log("<span style='color:red'>Simulation Error: " + e.message + "</span>"); }
        });
        
        setTimeout(updateCode, 100);
    </script>
</body>
</html>
